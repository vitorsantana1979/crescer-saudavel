========================================
PROMPT PARA IA DO SERVIDOR - DEPLOY CRESCER SAUDÁVEL
========================================

OBJETIVO:
Atualizar sistema Crescer Saudável em cs.quasarai.co para incluir novos endpoints de IA/ML e corrigir erro 404 ao recarregar página.

CONTEXTO DO SISTEMA:
- Domínio: cs.quasarai.co
- Proxy: Caddy
- Backend: C# .NET 8 (porta 5280)
- ML Service: Python FastAPI (porta 8000)
- Frontend: React SPA (porta 80/5173)
- Compose file: docker-compose.production.yml

PROBLEMAS ATUAIS:
1. API retorna 404 para /api/analytics/predict-growth/{id}
2. SPA retorna 404 ao recarregar página com F5

========================================
TAREFA 1: ATUALIZAR CÓDIGO E REBUILD DOCKER
========================================

cd /var/www/crescer-saudavel
# (ou o caminho correto do projeto)

# Parar containers
docker-compose -f docker-compose.production.yml down

# Atualizar código do GitHub
git pull origin main

# Verificar se código foi atualizado (deve mostrar commits recentes)
git log --oneline -5

# Rebuild SEM CACHE (IMPORTANTE!)
docker-compose -f docker-compose.production.yml build --no-cache

# Subir containers
docker-compose -f docker-compose.production.yml up -d

# Aguardar inicialização
sleep 20

# Verificar status
docker-compose -f docker-compose.production.yml ps
# Todos devem estar "Up"

========================================
TAREFA 2: VERIFICAR SERVIÇOS
========================================

# Backend Health
curl http://localhost:5280/api/health
# Esperado: {"ok":true}

# ML Service Health  
curl http://localhost:8000/health
# Esperado: {"status":"healthy","database_connected":true,"models_loaded":true}

# NOVO ENDPOINT - Analytics Stats
curl http://localhost:5280/api/analytics/stats
# Se retornar JSON → ✅ Backend atualizado
# Se retornar 404 → ❌ Rebuild não funcionou

# NOVO ENDPOINT - Predict Growth (teste com ID fake)
curl -X POST http://localhost:5280/api/analytics/predict-growth/test-123 \
  -H "Content-Type: application/json" \
  -d '{}'
# Se retornar JSON ou erro 400 → ✅ Endpoint existe
# Se retornar 404 → ❌ Backend não atualizou

========================================
TAREFA 3: VERIFICAR LOGS SE HOUVER PROBLEMAS
========================================

# Backend logs
docker-compose -f docker-compose.production.yml logs backend --tail=100

# ML Service logs
docker-compose -f docker-compose.production.yml logs ml-service --tail=100

# Procurar erros
docker-compose -f docker-compose.production.yml logs | grep -i "error\|exception\|failed"

# Verificar se ML Service carregou os routers
docker-compose -f docker-compose.production.yml logs ml-service | grep -i "router"

# Deve mostrar:
# "Routers carregados com sucesso"

========================================
TAREFA 4: CONFIGURAR CADDY PARA SPA ROUTING
========================================

# Localizar Caddyfile
ls -la /etc/caddy/Caddyfile
# OU
find / -name "Caddyfile" 2>/dev/null | head -5

# Editar Caddyfile
nano /etc/caddy/Caddyfile

# CONFIGURAÇÃO NECESSÁRIA:

cs.quasarai.co {
    # Logs
    log {
        output file /var/log/caddy/access.log
    }

    # API Backend (C#)
    handle /api/* {
        reverse_proxy localhost:5280 {
            header_up Host {host}
            header_up X-Real-IP {remote}
            header_up X-Forwarded-For {remote}
            header_up X-Forwarded-Proto {scheme}
        }
    }

    # Frontend SPA (React)
    handle {
        reverse_proxy localhost:80 {
            header_up Host {host}
            header_up X-Real-IP {remote}
        }
    }

    # Compressão
    encode gzip zstd
}

# Salvar (Ctrl+O, Enter, Ctrl+X)

# Validar configuração
caddy validate --config /etc/caddy/Caddyfile

# Se válida, recarregar
caddy reload --config /etc/caddy/Caddyfile

# OU (se Caddy é um serviço systemd)
systemctl reload caddy

========================================
TAREFA 5: CONFIGURAR NGINX NO FRONTEND (SE APLICÁVEL)
========================================

Se o frontend está em um container Docker com Nginx, verificar:

docker-compose -f docker-compose.production.yml exec frontend cat /etc/nginx/conf.d/default.conf

# Deve conter:
location / {
    root /usr/share/nginx/html;
    index index.html;
    try_files $uri $uri/ /index.html;
}

# Se NÃO tiver, adicionar ao Dockerfile do frontend:

FROM nginx:alpine
COPY dist /usr/share/nginx/html

# Criar configuração SPA
RUN echo 'server { \
    listen 80; \
    server_name _; \
    root /usr/share/nginx/html; \
    index index.html; \
    \
    location / { \
        try_files $uri $uri/ /index.html; \
    } \
    \
    location ~* \\.(?:css|js|jpg|svg|png|woff|woff2|ttf|eot)$ { \
        expires 1y; \
        add_header Cache-Control "public, immutable"; \
    } \
}' > /etc/nginx/conf.d/default.conf

EXPOSE 80
CMD ["nginx", "-g", "daemon off;"]

# Depois rebuild do frontend:
docker-compose -f docker-compose.production.yml build --no-cache frontend
docker-compose -f docker-compose.production.yml up -d

========================================
TAREFA 6: TESTES FINAIS
========================================

# 1. Testar API Backend
curl https://cs.quasarai.co/api/health
# Esperado: {"ok":true}

# 2. Testar novo endpoint Analytics
curl https://cs.quasarai.co/api/analytics/stats
# Esperado: JSON com estatísticas

# 3. Testar SPA routing no navegador
# - Abrir: https://cs.quasarai.co
# - Fazer login
# - Navegar para: https://cs.quasarai.co/ia-insights/qualquer-id
# - Apertar F5
# - ✅ NÃO deve dar 404

# 4. Testar Chat IA
# - Menu → Chat IA Clínico
# - Enviar mensagem: "Olá"
# - ✅ Deve responder

# 5. Testar Predições ML
# - Abrir paciente → Ver Insights IA
# - Clicar "Gerar Predição"
# - ✅ Deve retornar predições sem 404

========================================
TROUBLESHOOTING
========================================

SE API AINDA RETORNA 404:

# Verificar se Backend tem os arquivos compilados recentes
docker-compose -f docker-compose.production.yml exec backend ls -lh /app/*.dll

# Verificar variáveis de ambiente no Backend
docker-compose -f docker-compose.production.yml exec backend env | grep -E "MLService|OpenAI"

# Deve mostrar:
# MLService__BaseUrl=http://ml-service:8000
# OpenAI__ApiKey=sk-proj-...

# Rebuild forçado completo
docker-compose -f docker-compose.production.yml down -v
docker system prune -af
docker-compose -f docker-compose.production.yml build --no-cache --pull
docker-compose -f docker-compose.production.yml up -d


SE ML SERVICE RETORNA 404:

# Verificar se ML Service está respondendo
curl http://localhost:8000/docs
# Deve mostrar documentação Swagger

# Listar endpoints disponíveis
curl http://localhost:8000/openapi.json | grep -o '"path":"[^"]*"' | sort -u

# Deve incluir:
# "/api/v1/predictions/growth"
# "/api/v1/analytics/similar-cases"

# Entrar no container ML
docker-compose -f docker-compose.production.yml exec ml-service bash

# Verificar arquivos Python
ls -la /app/app/routers/
# Deve conter: predictions.py, analytics.py, food_analytics.py

# Testar endpoint internamente
curl http://localhost:8000/api/v1/predictions/growth -X POST -H "Content-Type: application/json" -d '{}'

exit


SE SPA AINDA DÁ 404 AO RECARREGAR:

# Verificar logs do Caddy
journalctl -u caddy --since "5 minutes ago" | grep 404

# Testar acesso direto ao frontend
curl -I http://localhost:80/ia-insights/test

# Verificar configuração Nginx no container
docker-compose -f docker-compose.production.yml exec frontend cat /etc/nginx/conf.d/default.conf

# Se não tiver try_files, rebuild do frontend necessário


SE CONTAINERS NÃO SOBEM:

# Ver logs detalhados
docker-compose -f docker-compose.production.yml logs --tail=200

# Verificar espaço em disco
df -h

# Limpar espaço Docker se necessário
docker system prune -af --volumes

========================================
ARQUIVO .env NECESSÁRIO
========================================

Verificar se existe e tem o conteúdo correto:

cat .env

# Deve conter:
DATABASE_SERVER=sql.vsantana.com.br:1279
DATABASE_NAME=crescer
DATABASE_USER=crescer
DATABASE_PASSWORD=Cr35c3r@2024
OPENAI_API_KEY=sk-proj-z7BCuAqti...
OpenAI__ApiKey=sk-proj-z7BCuAqti...
ASPNETCORE_ENVIRONMENT=Production
VITE_API_URL=https://cs.quasarai.co/api

========================================
CHECKLIST FINAL
========================================

[ ] Git pull executado e código atualizado
[ ] docker-compose build --no-cache executado
[ ] Todos containers UP (docker-compose ps)
[ ] Backend health OK (curl localhost:5280/api/health)
[ ] ML Service health OK (curl localhost:8000/health)
[ ] Endpoint analytics existe (curl localhost:5280/api/analytics/stats)
[ ] Caddy configurado com proxy correto
[ ] SPA routing configurado (try_files)
[ ] Caddy recarregado
[ ] Site acessível (https://cs.quasarai.co)
[ ] F5 não dá 404
[ ] IA Insights carrega sem 404
[ ] Chat IA funciona

========================================
RESPONDA COM:
========================================

1. Output de: docker-compose -f docker-compose.production.yml ps
2. Output de: curl http://localhost:5280/api/analytics/stats
3. Output de: curl http://localhost:8000/health
4. Últimas 50 linhas dos logs: docker-compose -f docker-compose.production.yml logs backend --tail=50
5. Status do Caddy: systemctl status caddy
6. Teste no navegador: https://cs.quasarai.co carrega? F5 funciona?

========================================

